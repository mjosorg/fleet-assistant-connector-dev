#!/command/with-contenv bashio
# ==============================================================================
# Home Assistant Add-on: Fleet Assistant Connector
# Creates the interface configuration
# ==============================================================================
declare config_dir
declare clientname
declare peer_private_key
declare peer_public_key
declare publickey
declare tunnelip
declare host
declare port
declare post_down
declare post_up
declare fleet_assistant_server_ip

clientname="fleet-assistant"
config_dir="/data/fleet-assistant"

# Wireguard configuration directory
if ! bashio::fs.directory_exists '/etc/wireguard'; then
    mkdir -p /etc/wireguard ||
        bashio::exit.nok "Could not create wireguard folder!"
fi

# Wireguard configuration directory for persistent storage
if ! bashio::fs.directory_exists "${config_dir}"; then
    mkdir -p ${config_dir} ||
        bashio::exit.nok "Could not create persistent storage folder for fleet-assistant!"
fi

# If private key not exists create a new one.
if ! bashio::fs.file_exists "${config_dir}/private_key"; then
    umask 077 || bashio::exit.nok "Could not set a proper umask"
    wg genkey > "${config_dir}/private_key" ||
        bashio::exit.nok "Could not generate private key for ${clientname}!"
fi
peer_private_key=$(<"${config_dir}/private_key")

# Get the public, create key if not exists
if ! bashio::fs.file_exists "${config_dir}/public_key"; then
    peer_public_key=""
    bashio::var.has_value "${peer_private_key}";
    peer_public_key=$(wg pubkey <<< "${peer_private_key}")
    echo "$peer_public_key" > "${config_dir}/public_key"
    bashio::log.info "Public key= $peer_public_key"

fi
# Get config input from addon UI
if bashio::config.has_value "server.publickey"; then
    publickey=$(bashio::config "server.publickey")
fi
if bashio::config.has_value "server.tunnelip"; then
    tunnelip=$(bashio::config "server.tunnelip")
fi

if bashio::config.has_value "server.host"; then
    host=$(bashio::config "server.host")
fi
if bashio::config.has_value "server.port"; then
    port=$(bashio::config "server.port")
fi
if bashio::config.has_value "server.fleet_assistant_server_ip"; then
    fleet_assistant_server_ip=$(bashio::config "server.fleet_assistant_server_ip")
fi
# The post up lines are needed for the addon to access Home Assistant core container
post_up="nft add table ip nat 2>/dev/null; nft add chain ip nat PREROUTING { type nat hook prerouting priority 0 \; } 2>/dev/null; nft add chain ip nat POSTROUTING { type nat hook postrouting priority 100 \; } 2>/dev/null; nft add rule ip nat PREROUTING dnat to 172.30.32.1; nft add rule ip nat POSTROUTING masquerade"
post_down="nft flush table ip nat; nft delete table ip nat"

# Write full config file.
{
echo "[Interface]"
echo "Address = ${tunnelip}"
echo "PrivateKey = ${peer_private_key}"
echo "PostUp = ${post_up}"
echo "PostDown = ${post_down}"
echo "[Peer]"
echo "PublicKey = ${publickey}"
echo "AllowedIPs = ${fleet_assistant_server_ip}/32"
echo "Endpoint = ${host}:${port}"
echo "PersistentKeepalive = 25"
echo ""
} > "${config_dir}/${clientname}.conf"


# Move config file to /etc/wireguard if the file does not exist
if ! bashio::fs.file_exists "/etc/wireguard/${clientname}.conf"; then
    cp "${config_dir}/${clientname}.conf" "/etc/wireguard/${clientname}.conf" ||
        bashio::exit.nok "Unable to move config file to /etc/wireguard"
fi

# Print the public key to the log
pubkey=$(cat "${config_dir}/public_key")
bashio::log.info "The wireguard public key is: $pubkey"
